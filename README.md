# ASFA Production Deployment Script

Automated deployment script for Acer School Finance App (ASFA) on Ubuntu/Debian VPS.

## Features

- ✅ Automated Docker & Docker Compose installation
- ✅ SSL certificate setup (Let's Encrypt or Cloudflare Origin)
- ✅ Multi-tenant support with nginx
- ✅ Health checks and monitoring
- ✅ Automatic service management with systemd
- ✅ Management scripts for daily operations
- ✅ Firewall configuration with UFW
- ✅ Environment configuration wizard
- ✅ Cloudflare R2 integration

## Quick Start

### Prerequisites

- Ubuntu 20.04+ or Debian 11+ VPS
- Root or sudo access
- Domain name configured
- Docker Hub access to private image
- Cloudflare account (for R2 and SSL)

### Installation

On your VPS, run:

```bash
curl -O https://raw.githubusercontent.com/paulmbui20/asfa-deploy-script/main/deploy.sh
chmod +x deploy.sh
./deploy.sh
```

Follow the interactive prompts to configure your deployment.

## What Gets Installed

- **Docker & Docker Compose** - Container runtime
- **nginx** (in Docker) - Web server with SSL
- **Redis** - Caching and task queue
- **PostgreSQL** (external) - Database
- **Celery** - Background task processing
- **UFW** - Firewall

## Configuration Files

The script will create:

- `compose.prod.yaml` - Docker Compose configuration
- `.env.docker` - Environment variables
- `nginx/nginx.conf` - nginx configuration
- `nginx/ssl/` - SSL certificates
- Management scripts (deploy.sh, logs.sh, etc.)

## SSL Options

### 1. Let's Encrypt (Recommended for most)
- Free, auto-renewing certificates
- Trusted by all browsers
- Requires domain pointing to server

### 2. Cloudflare Origin Certificate (Recommended for Cloudflare users)
- 15-year validity
- Works with Cloudflare proxy
- Manual setup required

### 3. HTTP Only
- For testing only
- Not recommended for production

## Post-Installation

After deployment completes:

```bash
cd /opt/apps/asfa

# Create Django superuser
docker compose -f compose.prod.yaml exec web python manage.py createsuperuser

# Create your first school tenant
docker compose -f compose.prod.yaml exec web python manage.py create_tenant

# View logs
./logs.sh
```

## Management Commands

```bash
./deploy.sh      # Deploy/update application
./logs.sh        # View logs (all services)
./logs.sh web    # View specific service logs
./status.sh      # Check service status
./stop.sh        # Stop all services
./start.sh       # Start all services
./reconfig.sh    # Update configuration
./backup.sh      # Backup database
```

## Architecture

```
┌─────────────┐
│  Cloudflare │ (DNS, SSL, CDN)
└──────┬──────┘
       │
┌──────▼──────────────────────┐
│     Your VPS (Ubuntu)       │
│                             │
│  ┌────────────────────┐    │
│  │  nginx (Docker)     │    │
│  │  - SSL termination  │    │
│  │  - Rate limiting    │    │
│  │  - Load balancing   │    │
│  └─────────┬──────────┘    │
│            │                │
│  ┌─────────▼──────────┐    │
│  │  Django Web         │    │
│  │  - Multi-tenant     │    │
│  │  - API endpoints    │    │
│  └─────────┬──────────┘    │
│            │                │
│  ┌─────────▼──────────┐    │
│  │  Celery Workers     │    │
│  │  - Background tasks │    │
│  └────────────────────┘    │
│                             │
│  ┌────────────────────┐    │
│  │  Redis              │    │
│  │  - Cache            │    │
│  │  - Task queue       │    │
│  └────────────────────┘    │
└─────────────────────────────┘
         │         │
    ┌────▼────┐   └──────┐
    │PostgreSQL│    │ R2  │
    │(External) │   │(CDN)│
    └──────────┘    └─────┘
```

## Environment Variables

Key variables to configure:

```env
# Django
DJANGO_SECRET_KEY=<auto-generated>
DEBUG=False
ALLOWED_HOSTS=yourdomain.com,www.yourdomain.com

# Database
DATABASE_URL=postgresql://user:pass@host:5432/dbname

# Redis (Docker service)
REDIS_URL=redis://redis:6379/0

# Email (Resend)
EMAIL_HOST_PASSWORD=re_your_api_key
DEFAULT_FROM_EMAIL=noreply@yourdomain.com

# Cloudflare R2
CLOUDFLARE_R2_ACCOUNT_ID=your-account-id
CLOUDFLARE_R2_PUBLIC_BUCKET=asfa-public
CLOUDFLARE_R2_PUBLIC_ACCESS_KEY=your-key
CLOUDFLARE_R2_PUBLIC_SECRET_KEY=your-secret

# Backups
BACKUP_R2_BUCKET_NAME=asfa-backups
```

## Cloudflare Configuration

### DNS Records
```
Type    Name    Content
A       @       your-vps-ip
A       www     your-vps-ip
A       *       your-vps-ip (for subdomains/tenants)
```

### SSL/TLS Settings
- **SSL/TLS encryption mode**: Full (strict)
- **Always Use HTTPS**: On
- **Minimum TLS Version**: 1.2

### Security
- **WAF**: Consider enabling
- **Rate Limiting**: Optional additional layer
- **Bot Fight Mode**: Recommended

## Troubleshooting

### Application won't start
```bash
./logs.sh web
```
Check for database connection or missing environment variables.

### SSL certificate issues
```bash
./logs.sh nginx
```
Verify certificates are in `nginx/ssl/` directory.

### 502 Bad Gateway
```bash
docker compose -f compose.prod.yaml ps
```
Check if all services are healthy.

## Updating

To update to a new version:

```bash
cd /opt/apps/asfa
./deploy.sh
```

The script will:
1. Pull the latest Docker image
2. Gracefully stop old containers
3. Start new containers
4. Run health checks

## Backup & Recovery

### Manual Backup
```bash
./backup.sh
```

### List Backups
```bash
docker compose -f compose.prod.yaml exec web python manage.py manage_backup
```

### Restore
```bash
docker compose -f compose.prod.yaml exec web python manage.py restore_backup
```

## Security Best Practices

1. ✅ Use strong passwords
2. ✅ Keep system updated: `sudo apt update && sudo apt upgrade`
3. ✅ Enable UFW firewall
4. ✅ Use SSH keys instead of passwords
5. ✅ Regular backups
6. ✅ Monitor logs
7. ✅ Use Cloudflare WAF

## Requirements

### Server Specifications
- **Minimum**: 2 CPU cores, 2GB RAM, 20GB storage
- **Recommended**: 4 CPU cores, 4GB RAM, 50GB storage
- **OS**: Ubuntu 20.04 LTS or newer, Debian 11+

### External Services
- PostgreSQL database (can be on same server or external)
- Cloudflare account with R2 storage
- Domain name
- Email service (Resend recommended)

## Support

For issues or questions:
1. Check the [Deployment Guide](DEPLOYMENT_GUIDE.md)
2. Review logs: `./logs.sh`
3. Check service status: `./status.sh`

## Alternative Deployment  with Docker Compose

if you have already set up the application before eg logging in to docker hub, setup .env.docker, and ran it successfully before, you can use the docker compose file to deploy the application.
```bash
# Download the script
curl -O https://raw.githubusercontent.com/paulmbui20/asfa-deploy-script/main/compose.prod.yaml

# Make it executable
chmod +x compose.prod.yaml


# Run it
docker compose -f compose.prod.yaml up -d
```


## License

This deployment script is provided as-is for ASFA application deployment.

## Contributors


- [@paulmbui20](https://github.com/paulmbui20/asfa-deploy-script.git)

---
